package encode

import (
	"fmt"
	"testing"

	"github.com/dcaravel/stackrox-deserialize/internal/decode"
	"github.com/stretchr/testify/assert"
)

func TestNameTypeDetect(t *testing.T) {
	tcs := []struct {
		expectedName string
		data         string
	}{
		{
			"Blob",
			`\x0a262f6c6f63616c63616368652f65787465726e616c2d6e6574776f726b732f636865636b73756d10e18c0120402a0c08cc8788c10610fbfcc48d02320c08cc8788c106108d86c58d02`,
		},
		{
			"DelegatedRegistryConfig",
			`\x0801122463663436363334362d633837652d343737372d386165392d6631643061313666303161641a060a04617364661a2c0a0466646173122463663436363334362d633837652d343737372d386165392d663164306131366630316164`,
		},
		{
			"ImageIntegration",
			`\x0a2431306433623464632d383239352d343162632d626235302d36646135343834636462316112105075626c696320446f636b65724875621a06646f636b65723201004a160a1472656769737472792d312e646f636b65722e696f`,
		},
		{
			"Alert",
			`\x0a2434303439346462642d383739382d343163662d393961612d376533633236653233613039128f050a2461393139636361662d366234332d343136302d616335642d613430356531343430613431122346697861626c65205365766572697479206174206c6561737420496d706f7274616e741a5b416c657274206f6e206465706c6f796d656e747320776974682066697861626c652076756c6e65726162696c69746965732077697468206120536576657269747920526174696e67206174206c6561737420496d706f7274616e7422be014b6e6f776e2076756c6e65726162696c6974696573206d616b652069742065617369657220666f7220616476657273617269657320746f206578706c6f697420796f7572206170706c69636174696f6e2e20596f752063616e2066697820746865736520686967682d73657665726974792076756c6e65726162696c6974696573206279207570646174696e6720746f2061206e657765722076657273696f6e206f662074686520616666656374656420636f6d706f6e656e742873292e2a880155736520796f7572207061636b616765206d616e6167657220746f2075706461746520746f20612066697865642076657273696f6e20696e20667574757265206275696c6473206f7220737065616b207769746820796f7572207365637572697479207465616d20746f206d69746967617465207468652076756c6e65726162696c69746965732e3a1856756c6e65726162696c697479204d616e6167656d656e744a02010060036a010482012346697861626c65205365766572697479206174206c6561737420496d706f7274616e748a010c4255494c442c4445504c4f599001019a0103312e31a2012e1a100a08466978656420427922040a022e2a1a1a0a085365766572697479220e0a0c3e3d20494d504f5254414e54c00101c80101d001012aaf010aac0146697861626c65204356452d323032352d323238363920284356535320372e35292028736576657269747920496d706f7274616e742920666f756e6420696e20636f6d706f6e656e742027676f6c616e672e6f72672f782f63727970746f27202876657273696f6e2076302e33322e302920696e20636f6e7461696e6572202772656769737472792d736572766572272c207265736f6c7665642062792076657273696f6e20302e33352e303a0c08c09d89c10610c382c1e901520c08c09d89c10610c382c1e90158028a010c08c09d89c10610d6d1b0a00292012463663436363334362d633837652d343737372d386165392d6631643061313666303161649a010672656d6f7465a201156f70656e73686966742d6d61726b6574706c616365aa012430313230393436642d656639362d343639612d386338632d663031306264336466383737b00101b8010122e6060a2466323437656435332d356534362d346632392d626631652d3034303138343638343834311219636f6d6d756e6974792d6f70657261746f72732d78626735742203506f642a156f70656e73686966742d6d61726b6574706c6163653a400a29636174616c6f67736f757263652e6f70657261746f72732e636f72656f732e636f6d2f7570646174651213636f6d6d756e6974792d6f70657261746f72733a150a116f6c6d2e636174616c6f67536f7572636512003a130a0b6f6c6d2e6d616e616765641204747275653a3b0a116f6c6d2e706f642d737065632d6861736812263863486f6167487a5957704636433947734e7a547a6f496c4a366e7a5a34593452426352714b4a2463663436363334362d633837652d343737372d386165392d663164306131366630316164520672656d6f74655a89021af5010aa9010a07717561792e696f12266f70656e73686966742d72656c656173652d6465762f6f63702d76342e302d6172742d6465762276717561792e696f2f6f70656e73686966742d72656c656173652d6465762f6f63702d76342e302d6172742d646576407368613235363a3831616532356336646663326663386135646632333735373266353335613038633833613362643065333735353562323333323934306238353063313763613022477368613235363a38316165323563366466633266633861356466323337353732663533356130386338336133626430653337353535623233333239343062383530633137636130520f72656769737472792d736572766572723b0a28736563636f6d702e73656375726974792e616c7068612e6b756265726e657465732e696f2f706f64120f72756e74696d652f64656661756c7472360a2e636c75737465722d6175746f7363616c65722e6b756265726e657465732e696f2f736166652d746f2d6576696374120474727565722a0a196f70656e73686966742e696f2f72657175697265642d736363120d726573747269637465642d763272210a106f70656e73686966742e696f2f736363120d726573747269637465642d763272370a1f6f70657261746f726672616d65776f726b2e696f2f6d616e616765642d627912146d61726b6574706c6163652d6f70657261746f7282012430313230393436642d656639362d343639612d386338632d663031306264336466383737`,
		},
		{
			"Image",
			`\x0a420a09646f636b65722e696f120d6c6962726172792f6e67696e781a066c6174657374221e646f636b65722e696f2f6c6962726172792f6e67696e783a6c617465737412fa310af32c0a477368613235363a61383330373037313732653830363963303963663663363761303465323365356131613333326437306139306135343939396237363237336139323862396365120608b787ffbf0622470a0352554e1238232064656269616e2e7368202d2d617263682027616d64363427206f75742f2027626f6f6b776f726d2720274031373435373938343030271a0608b787ffbf06224f0a054c4142454c123c6d61696e7461696e65723d4e47494e5820446f636b6572204d61696e7461696e657273203c646f636b65722d6d61696e74406e67696e782e636f6d3e1a0608b787ffbf06300122250a03454e5612144e47494e585f56455253494f4e3d312e32372e351a0608b787ffbf06300122230a03454e5612124e4a535f56455253494f4e3d302e382e31301a0608b787ffbf06300122270a03454e5612164e4a535f52454c454153453d317e626f6f6b776f726d1a0608b787ffbf06300122270a03454e561216504b475f52454c454153453d317e626f6f6b776f726d1a0608b787ffbf063001222a0a03454e56121944594e504b475f52454c454153453d317e626f6f6b776f726d1a0608b787ffbf06300122b6240a0352554e12a6242f62696e2f7368202d6320736574202d78202020202026262067726f7570616464202d2d73797374656d202d2d67696420313031206e67696e78202020202026262075736572616464202d2d73797374656d202d2d676964206e67696e78202d2d6e6f2d6372656174652d686f6d65202d2d686f6d65202f6e6f6e6578697374656e74202d2d636f6d6d656e7420226e67696e78207573657222202d2d7368656c6c202f62696e2f66616c7365202d2d75696420313031206e67696e7820202020202626206170742d6765742075706461746520202020202626206170742d67657420696e7374616c6c202d2d6e6f2d696e7374616c6c2d7265636f6d6d656e6473202d2d6e6f2d696e7374616c6c2d7375676765737473202d7920676e757067312063612d6365727469666963617465732020202020262620202020204e47494e585f4750474b4559533d223537334246443642334438464243363431303739413641424142463542443832374244394246363220383534304136463138383333413830453943313635334134324644323133313042343946364234362039453942453930454143424344453639464539423230344342434443443841333844383841324233223b20202020204e47494e585f4750474b45595f504154483d2f6574632f6170742f6b657972696e67732f6e67696e782d617263686976652d6b657972696e672e6770673b20202020206578706f727420474e555047484f4d453d2224286d6b74656d70202d6429223b2020202020666f756e643d27273b2020202020666f72204e47494e585f4750474b455920696e20244e47494e585f4750474b4559533b20646f2020202020666f722073657276657220696e202020202020202020686b703a2f2f6b65797365727665722e7562756e74752e636f6d3a38302020202020202020207067702e6d69742e65647520202020203b20646f2020202020202020206563686f20224665746368696e6720475047206b657920244e47494e585f4750474b45592066726f6d2024736572766572223b20202020202020202067706731202d2d6b657973657276657220222473657276657222202d2d6b65797365727665722d6f7074696f6e732074696d656f75743d3130202d2d726563762d6b6579732022244e47494e585f4750474b45592220262620666f756e643d79657320262620627265616b3b2020202020646f6e653b202020202074657374202d7a202224666f756e6422202626206563686f203e263220226572726f723a206661696c656420746f20666574636820475047206b657920244e47494e585f4750474b455922202626206578697420313b2020202020646f6e653b202020202067706731202d2d6578706f72742022244e47494e585f4750474b45595322203e2022244e47494e585f4750474b45595f5041544822203b2020202020726d202d7266202224474e555047484f4d45223b20202020206170742d6765742072656d6f7665202d2d7075726765202d2d6175746f2d72656d6f7665202d7920676e7570673120262620726d202d7266202f7661722f6c69622f6170742f6c697374732f2a202020202026262064706b67417263683d22242864706b67202d2d7072696e742d617263686974656374757265292220202020202626206e67696e785061636b616765733d222020202020202020206e67696e783d247b4e47494e585f56455253494f4e7d2d247b504b475f52454c454153457d2020202020202020206e67696e782d6d6f64756c652d78736c743d247b4e47494e585f56455253494f4e7d2d247b44594e504b475f52454c454153457d2020202020202020206e67696e782d6d6f64756c652d67656f69703d247b4e47494e585f56455253494f4e7d2d247b44594e504b475f52454c454153457d2020202020202020206e67696e782d6d6f64756c652d696d6167652d66696c7465723d247b4e47494e585f56455253494f4e7d2d247b44594e504b475f52454c454153457d2020202020202020206e67696e782d6d6f64756c652d6e6a733d247b4e47494e585f56455253494f4e7d2b247b4e4a535f56455253494f4e7d2d247b4e4a535f52454c454153457d20202020202220202020202626206361736520222464706b67417263682220696e202020202020202020616d6436347c61726d363429202020202020202020202020206563686f2022646562205b7369676e65642d62793d244e47494e585f4750474b45595f504154485d2068747470733a2f2f6e67696e782e6f72672f7061636b616765732f6d61696e6c696e652f64656269616e2f20626f6f6b776f726d206e67696e7822203e3e202f6574632f6170742f736f75726365732e6c6973742e642f6e67696e782e6c697374202020202020202020202020202626206170742d67657420757064617465202020202020202020202020203b3b2020202020202020202a292020202020202020202020202074656d704469723d2224286d6b74656d70202d6429222020202020202020202020202026262063686d6f642037373720222474656d70446972222020202020202020202020202020202020202020202020202026262073617665644170744d61726b3d2224286170742d6d61726b2073686f776d616e75616c2922202020202020202020202020202020202020202020202020202626206170742d67657420757064617465202020202020202020202020202626206170742d67657420696e7374616c6c202d2d6e6f2d696e7374616c6c2d7265636f6d6d656e6473202d2d6e6f2d696e7374616c6c2d7375676765737473202d7920202020202020202020202020202020206375726c2020202020202020202020202020202020646576736372697074732020202020202020202020202020202020657175697673202020202020202020202020202020202067697420202020202020202020202020202020206c6962786d6c322d7574696c7320202020202020202020202020202020206c73622d72656c65617365202020202020202020202020202020202078736c7470726f6320202020202020202020202020262620282020202020202020202020202020202020636420222474656d704469722220202020202020202020202020202020202626205245564953494f4e3d22247b4e47494e585f56455253494f4e7d2d247b504b475f52454c454153457d2220202020202020202020202020202020202626205245564953494f4e3d247b5245564953494f4e257e2a7d20202020202020202020202020202020202626206375726c202d66202d4c202d4f2068747470733a2f2f6769746875622e636f6d2f6e67696e782f706b672d6f73732f617263686976652f247b5245564953494f4e7d2e7461722e677a2020202020202020202020202020202020262620504b474f5353434845434b53554d3d226337373364393862353637626435383563313766353537303262663365346337643832623637366266626465333935323730653930613730346463613363373538646665303338306233663031373730353432623466643962656431663131343961663463653238626663353461323761393664663662373030616331373435202a247b5245564953494f4e7d2e7461722e677a2220202020202020202020202020202020202626206966205b202224286f70656e73736c20736861353132202d7220247b5245564953494f4e7d2e7461722e677a2922203d202224504b474f5353434845434b53554d22205d3b207468656e2020202020202020202020202020202020202020206563686f2022706b672d6f73732074617262616c6c20636865636b73756d20766572696669636174696f6e2073756363656564656421223b2020202020202020202020202020202020656c73652020202020202020202020202020202020202020206563686f2022706b672d6f73732074617262616c6c20636865636b73756d20766572696669636174696f6e206661696c656421223b2020202020202020202020202020202020202020206578697420313b20202020202020202020202020202020206669202020202020202020202020202020202026262074617220787a766620247b5245564953494f4e7d2e7461722e677a2020202020202020202020202020202020262620636420706b672d6f73732d247b5245564953494f4e7d202020202020202020202020202020202026262063642064656269616e2020202020202020202020202020202020262620666f722074617267657420696e2062617365206d6f64756c652d67656f6970206d6f64756c652d696d6167652d66696c746572206d6f64756c652d6e6a73206d6f64756c652d78736c743b20646f2020202020202020202020202020202020202020206d616b652072756c65732d247461726765743b2020202020202020202020202020202020202020206d6b2d6275696c642d64657073202d2d696e7374616c6c202d2d746f6f6c3d226170742d676574202d6f2044656275673a3a706b6750726f626c656d5265736f6c7665723d796573202d2d6e6f2d696e7374616c6c2d7265636f6d6d656e6473202d2d796573222020202020202020202020202020202020202020202020202064656275696c642d247461726765742f6e67696e782d244e47494e585f56455253494f4e2f64656269616e2f636f6e74726f6c3b2020202020202020202020202020202020646f6e6520202020202020202020202020202020202626206d616b652062617365206d6f64756c652d67656f6970206d6f64756c652d696d6167652d66696c746572206d6f64756c652d6e6a73206d6f64756c652d78736c742020202020202020202020202029202020202020202020202020202020202020202020202020202626206170742d6d61726b2073686f776d616e75616c207c207861726773206170742d6d61726b206175746f203e202f6465762f6e756c6c202020202020202020202020202626207b205b202d7a20222473617665644170744d61726b22205d207c7c206170742d6d61726b206d616e75616c202473617665644170744d61726b3b207d202020202020202020202020202020202020202020202020202626206c73202d6c41466820222474656d7044697222202020202020202020202020202626202820636420222474656d70446972222026262064706b672d7363616e7061636b61676573202e203e205061636b616765732029202020202020202020202020202626206772657020275e5061636b6167653a202720222474656d704469722f5061636b6167657322202020202020202020202020202626206563686f2022646562205b20747275737465643d796573205d2066696c653a2f2f2474656d70446972202e2f22203e202f6574632f6170742f736f75726365732e6c6973742e642f74656d702e6c697374202020202020202020202020202626206170742d676574202d6f20416371756972653a3a477a6970496e64657865733d66616c736520757064617465202020202020202020202020203b3b2020202020657361632020202020202020202626206170742d67657420696e7374616c6c202d2d6e6f2d696e7374616c6c2d7265636f6d6d656e6473202d2d6e6f2d696e7374616c6c2d7375676765737473202d7920202020202020202020202020202020202020202020202020246e67696e785061636b6167657320202020202020202020202020202020202020202020202020676574746578742d62617365202020202020202020202020202020202020202020202020206375726c20202020202626206170742d6765742072656d6f7665202d2d7075726765202d2d6175746f2d72656d6f7665202d7920262620726d202d7266202f7661722f6c69622f6170742f6c697374732f2a202f6574632f6170742f736f75726365732e6c6973742e642f6e67696e782e6c6973742020202020202020202626206966205b202d6e20222474656d7044697222205d3b207468656e2020202020202020206170742d676574207075726765202d79202d2d6175746f2d72656d6f7665202020202020202020262620726d202d726620222474656d7044697222202f6574632f6170742f736f75726365732e6c6973742e642f74656d702e6c6973743b2020202020666920202020202626206c6e202d7366202f6465762f7374646f7574202f7661722f6c6f672f6e67696e782f6163636573732e6c6f6720202020202626206c6e202d7366202f6465762f737464657272202f7661722f6c6f672f6e67696e782f6572726f722e6c6f6720202020202626206d6b646972202f646f636b65722d656e747279706f696e742e642023206275696c646b69741a0608b787ffbf0622310a04434f50591221646f636b65722d656e747279706f696e742e7368202f2023206275696c646b69741a0608b787ffbf06224f0a04434f5059123f31302d6c697374656e2d6f6e2d697076362d62792d64656661756c742e7368202f646f636b65722d656e747279706f696e742e642023206275696c646b69741a0608b787ffbf0622480a04434f5059123831352d6c6f63616c2d7265736f6c766572732e656e767368202f646f636b65722d656e747279706f696e742e642023206275696c646b69741a0608b787ffbf06224b0a04434f5059123b32302d656e7673756273742d6f6e2d74656d706c617465732e7368202f646f636b65722d656e747279706f696e742e642023206275696c646b69741a0608b787ffbf06224b0a04434f5059123b33302d74756e652d776f726b65722d70726f6365737365732e7368202f646f636b65722d656e747279706f696e742e642023206275696c646b69741a0608b787ffbf0622310a0a454e545259504f494e5412195b222f646f636b65722d656e747279706f696e742e7368225d1a0608b787ffbf06300122220a064558504f5345120e6d61705b38302f7463703a7b7d5d1a0608b787ffbf063001221f0a0a53544f505349474e414c1207534947515549541a0608b787ffbf063001222d0a03434d44121c5b226e67696e782220222d672220226461656d6f6e206f66663b225d1a0608b787ffbf0630012a04726f6f7432056e67696e7832022d67320b6461656d6f6e206f66663b3a152f646f636b65722d656e747279706f696e742e73684a3f0a0a6d61696e7461696e657212314e47494e5820446f636b6572204d61696e7461696e657273203c646f636b65722d6d61696e74406e67696e782e636f6d3e12490a477368613235363a383862333338386561303663373236326534313061336162356330356463343038386237623339646561353639616464643863333037363666346634373434301a477368613235363a323534653732346437373836326463353361626264336266306532376639643266363432393339303963646433643061616436613866653561363638303635391a477368613235363a393133313135323932373530333563373765663331306665333861383138343163386633653061333234636636613638643836623336663438613134356430611a477368613235363a336535343464353363653439643430356134316264353965393764313032643737636335343132613731376233626165323239356432333763636466623730361a477368613235363a346632316564396163306330346161376336346666643332646630323566343534356162396630303764313735636538326339323039303335393064616563371a477368613235363a643338663265663264366632373065366263383763616434386534396135656334656264643266356431643439353563346466333738306461626266323339331a477368613235363a343061366539663465343536346263373231336633393833393634653736633237653164633934636562343733663034613834363066356539356533363564311a477368613235363a6433646335656337316539643664316130366131373430656662346138373562323862313032313636353039633835363363393062343866376335653062636222380a2431306433623464632d383239352d343162632d626235302d36646135343834636462316112105075626c696320446f636b65724875621a570a0c08d0d389c10610a5d7f8a2031a320a2461383734373165362d393637382d346536362d383334382d393165333032623664653037120a5363616e6e6572205634220964656269616e3a313238b8cdae8384af85b97b22477368613235363a383862333338386561303663373236326534313061336162356330356463343038386237623339646561353639616464643863333037363666346634373434302a0c08d0d389c10610c8e690da0365ccccdc407201028201008801019201420a09646f636b65722e696f120d6c6962726172792f6e67696e781a066c6174657374221e646f636b65722e696f2f6c6962726172792f6e67696e783a6c617465737438960140616dcdcc1c41`,
		},
	}
	for _, tc := range tcs {
		t.Run(tc.expectedName, func(t *testing.T) {
			dataB, err := decode.Hex([]byte(tc.data))
			assert.NoError(t, err)

			entries, err := JSONAll(dataB)
			assert.NoError(t, err)
			assert.NotEmpty(t, entries)

			first := entries[0].Name
			if tc.expectedName != first {
				for _, e := range entries {
					fmt.Printf("name: %s, datalen: %d, len(protojson): %d, len(rawjson) %d, numfields: %d, sizeof: %d\n", e.Name, e.DataLen, len(e.ProtoJSON), len(e.RawJSON), e.NumFields, e.SizeOf)
				}
				assert.Equal(t, tc.expectedName, first)
			}
		})
	}
}

func TestDataLen(t *testing.T) {
	data := []byte(`{"name": "steve", "age": 30, "flag": false, "otherFlag": true, "more": {"stuff": "1234567890"}}`)

	// assert.Equal(t, dataLen(data), 5+1+1
	r := dataLen(data)
	t.Logf("r = %v", r)

}
